# TubeFlow Release Workflow
# Creates verified releases with SHA256 checksums, attestation.json, and GitHub attestation
#
# Usage: Go to Actions > Release > Run workflow > Enter version (e.g., 1.0.0)
# The workflow creates a verified tag and release with all attestation files

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! [[ "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Error: Invalid version format. Use semantic versioning (e.g., 1.0.0 or 1.0.0-beta.1)"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "Error: Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Create release artifacts
        run: |
          mkdir -p dist
          VERSION="${{ inputs.version }}"

          # Create tarball from current commit
          git archive --format=tar.gz --prefix=tubeflow-${VERSION}/ \
            -o dist/tubeflow-${VERSION}.tar.gz HEAD

          echo "Created tarball:"
          ls -la dist/

      - name: Generate SHA256 checksums
        run: |
          cd dist
          sha256sum tubeflow-${{ inputs.version }}.tar.gz > SHA256SUMS
          echo "SHA256 checksums:"
          cat SHA256SUMS

      - name: Generate attestation.json (in-toto/SLSA format)
        run: |
          VERSION="${{ inputs.version }}"
          TARBALL="tubeflow-${VERSION}.tar.gz"
          TARBALL_SHA256=$(sha256sum dist/$TARBALL | cut -d' ' -f1)
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cat > dist/attestation.json << EOF
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "predicateType": "https://slsa.dev/provenance/v0.2",
            "subject": [
              {
                "name": "${TARBALL}",
                "digest": {
                  "sha256": "${TARBALL_SHA256}"
                }
              }
            ],
            "predicate": {
              "builder": {
                "id": "https://github.com/wnstify/tubeflow/actions/runs/${{ github.run_id }}"
              },
              "buildType": "https://github.com/actions/runner",
              "invocation": {
                "configSource": {
                  "uri": "git+https://github.com/${{ github.repository }}@refs/tags/v${VERSION}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  },
                  "entryPoint": ".github/workflows/release.yml"
                },
                "parameters": {
                  "version": "${VERSION}"
                }
              },
              "metadata": {
                "buildInvocationId": "${{ github.run_id }}-${{ github.run_attempt }}",
                "buildStartedOn": "${BUILD_TIME}",
                "completeness": {
                  "parameters": true,
                  "environment": true,
                  "materials": true
                },
                "reproducible": false
              },
              "materials": [
                {
                  "uri": "git+https://github.com/${{ github.repository }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              ]
            }
          }
          EOF

          echo "Generated attestation.json:"
          cat dist/attestation.json | head -30

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: dist/tubeflow-${{ inputs.version }}.tar.gz

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ inputs.version }}" -m "TubeFlow v${{ inputs.version }}"
          git push origin "v${{ inputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          files: |
            dist/tubeflow-${{ inputs.version }}.tar.gz
            dist/SHA256SUMS
            dist/attestation.json
          body: |
            ## TubeFlow v${{ inputs.version }}

            **Research-First YouTube Content Creation Pipeline for Claude Code**

            Transform a 4-hour content process into 30 minutes of focused work.

            ---

            ### Highlights

            - **9 Specialized AI Agents** - Research, create, publish, sync, social
            - **5-Agent Parallel Research** - Topic, competitor, SEO, community + strategist
            - **Complete 6-Stage Pipeline** - Research → Create → Review → Publish → Sync → Social
            - **YouTube-Native Formatting** - Proper `*bold*` syntax, not Markdown
            - **Platform-Specific Social** - LinkedIn, Twitter/X, Facebook optimization
            - **Voice Preservation** - Your writing style, amplified
            - **Cross-Platform Support** - macOS, Linux, Windows, WSL2

            ---

            ### Verify Release Integrity

            **SHA256 Checksum:**
            ```bash
            curl -LO https://github.com/wnstify/tubeflow/releases/download/v${{ inputs.version }}/SHA256SUMS
            sha256sum -c SHA256SUMS
            ```

            **GitHub Attestation:**
            ```bash
            gh attestation verify tubeflow-${{ inputs.version }}.tar.gz --owner wnstify
            ```

            ---

            ### Installation

            ```bash
            # Download and extract
            curl -LO https://github.com/wnstify/tubeflow/releases/download/v${{ inputs.version }}/tubeflow-${{ inputs.version }}.tar.gz
            tar -xzf tubeflow-${{ inputs.version }}.tar.gz
            cd tubeflow-${{ inputs.version }}

            # Run installer
            ./install.sh        # macOS/Linux/WSL2
            .\install.ps1       # Windows PowerShell
            ```

            ---

            ### Links

            - [Documentation](https://github.com/wnstify/tubeflow#readme)
            - [Changelog](https://github.com/wnstify/tubeflow/blob/main/CHANGELOG.md)
            - [Discord](https://wnstify.cc/discord)

            ---

            *Built by Simon at [Webnestify](https://webnestify.cloud)*
